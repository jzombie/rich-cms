<!DOCTYPE html>
<html lang="en">
 <head>
  <meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control"/>
  <meta content="no-cache" http-equiv="Pragma"/>
  <meta content="0" http-equiv="Expires"/>
  <meta charset="utf-8">
   <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>
     Mixture of Experts: How to Properly Scale LLMs
    </title>
    <link href="../styles/main.css" rel="stylesheet"/>
    <link href="../styles/pygments.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <link href="../images/thinker.png" rel="icon" type="image/png"/>
    <script src="../scripts/main.js">
    </script>
    <meta content="https://github.com/jzombie/rich-cms" name="generator">
     <meta content="2024-10-14 23:43:35 +0000" name="build_datetime"/>
     <meta content="449" name="word_count"/>
     <script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
     </script>
    </meta>
   </meta>
  </meta>
 </head>
 <body>
  <a class="no-css" href="#main-content">
   Skip to main content
  </a>
  <button aria-label="Toggle TOC" class="hamburger js-only" id="menu-toggle-button">
  </button>
  <aside>
   <header>
    <div class="page_title">
     Mixture of Experts: How to Properly Scale LLMs
    </div>
   </header>
   <nav class="toc">
    <ul>
     <li>
      <ul>
       <li>
        <a href="../index.html">
         Welcome to zenOSmosis
        </a>
       </li>
       <li>
        <a href="../Contact%20Me.html">
         Contact Me
        </a>
       </li>
       <li>
        <a href="../Disclaimer.html">
         Disclaimer
        </a>
       </li>
       <li>
        <a href="../Resume.html">
         Jeremy Harris' Resume
        </a>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li class="directory">
        <div class="label">
         <a href="../1.%20Think%20and%20Grow%20Rich/index.html">
          1. Think and Grow Rich
         </a>
        </div>
        <ul>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/index.html">
           Copyright / General Info
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/FOREWORD.html">
           FOREWORD: What Do You Want Most?
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%201.html">
           CHAPTER 1: Introduction
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%202.html">
           CHAPTER 2: Desire
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%203.html">
           CHAPTER 3: Faith
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%204.html">
           CHAPTER 4: Auto-Suggestion
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%205.html">
           CHAPTER 5: Specialized Knowledge
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%206.html">
           CHAPTER 6: Imagination
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%207.html">
           CHAPTER 7: Organized Planning
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%208.html">
           CHAPTER 8: Decision
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%209.html">
           CHAPTER 9: Persistence
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%2010.html">
           CHAPTER 10: Power of the Master Mind
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%2011.html">
           CHAPTER 11: The Mystery of Sex
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%2012.html">
           CHAPTER 12: The Subconscious Mind
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%2013.html">
           CHAPTER 13: The Brain
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%2014.html">
           CHAPTER 14: The Sixth Sense
          </a>
         </li>
         <li>
          <a href="../1.%20Think%20and%20Grow%20Rich/Chapter%2015.html">
           CHAPTER 15: How to Outwit the Six Ghosts of Fear
          </a>
         </li>
        </ul>
       </li>
       <li class="directory">
        <div class="label">
         <a href="../2.%20General%20Self-Improvement/12%20Laws%20of%20Karma.html">
          2. General Self-Improvement
         </a>
        </div>
        <ul>
         <li>
          <a href="../2.%20General%20Self-Improvement/12%20Laws%20of%20Karma.html">
           12 Laws of Karma
          </a>
         </li>
         <li>
          <a href="../2.%20General%20Self-Improvement/12%20Steps%20for%20Self%20Care.html">
           12 Steps for Self Care
          </a>
         </li>
         <li>
          <a href="../2.%20General%20Self-Improvement/Advice%20from%20Self-Made%20Millionaires.html">
           Advice from Self-Made Millionaires
          </a>
         </li>
         <li>
          <a href="../2.%20General%20Self-Improvement/Biggest%20Mistake.html">
           Biggest Mistake You Can Make
          </a>
         </li>
         <li>
          <a href="../2.%20General%20Self-Improvement/By%20Age%2040.html">
           By Age 40 You Should be Smart Enough to Realize This
          </a>
         </li>
         <li>
          <a href="../2.%20General%20Self-Improvement/Feynman%20Did%20Not%20Burn%20Out.html">
           Feynman Didn't Burn Out
          </a>
         </li>
         <li>
          <a href="../2.%20General%20Self-Improvement/Fix%20Yourself.html">
           Fix Yourself
          </a>
         </li>
         <li>
          <a href="../2.%20General%20Self-Improvement/Rule%20of%206ths.html">
           Rule of 6ths
          </a>
         </li>
        </ul>
       </li>
       <li class="directory active-dir">
        <div class="label">
         <a href="A%20Tester%20Walks%20Into%20A%20Bar.html">
          3. Nerdy Stuff
         </a>
        </div>
        <ul>
         <li>
          <a href="A%20Tester%20Walks%20Into%20A%20Bar.html">
           A Tester Walks Into A Bar
          </a>
         </li>
         <li>
          <a href="Avoid%20Python%20Dep%20Hell%20in%20New%20Packages.html">
           Avoid Python Dependency Hell When Creating New Packages
          </a>
         </li>
         <li>
          <a href="Debugging%20a%20Learning%20Algorithm.html">
           Debugging a Learning Algorithm
          </a>
         </li>
         <li>
          <a href="Engineering%20Blogs.html">
           Engineering Blogs
          </a>
         </li>
         <li>
          <a href="Formatting%20Test.html">
           Formatting Test
          </a>
         </li>
         <li>
          <a href="Free%20P2P%20Services.html">
           Free P2P Services
          </a>
         </li>
         <li>
          <a href="Generating%20Synthetic%20Data%20from%20a%20Pandas%20Dataframe.html">
           Generating Synthetic Data from a Pandas DataFrame
          </a>
         </li>
         <li>
          <a href="Hacker%20News%20API.html">
           Hacker News API
          </a>
         </li>
         <li>
          <a href="History%20of%20Doctype%20Declarations.html">
           History of Doctype Declarations
          </a>
         </li>
         <li>
          <a href="How%20to%20Resize%20Images%20Using%20ImageMagick%20on%20Linux.html">
           How to Resize Images Using ImageMagick on Linux
          </a>
         </li>
         <li>
          <a href="How%20to%20Use%20SVGR%20with%20Vite%20to%20Import%20SVGs%20as%20React%20Components.html">
           How to Use SVGR with Vite to Import SVGs as React Components
          </a>
         </li>
         <li>
          <a href="Implementing%20Full-Text%20Search.html">
           Implementing Full-Text Search (in a static HTML website)
          </a>
         </li>
         <li class="active">
          <a href="Mixture%20of%20Experts:%20How%20to%20Properly%20Scale%20LLMs.html">
           Mixture of Experts: How to Properly Scale LLMs
          </a>
         </li>
         <li>
          <a href="Python%20via%20WASM.html">
           Python via WASM
          </a>
         </li>
         <li>
          <a href="Restart%20VNC%20Server%20on%20macOS.html">
           Restart VNC Server on macOS
          </a>
         </li>
         <li>
          <a href="Rsync%20over%20SSH%20Examples.html">
           Rsync over SSH Examples
          </a>
         </li>
         <li>
          <a href="SSH%20Keygen.html">
           SSH Keygen for Password-less Server Login
          </a>
         </li>
         <li>
          <a href="Setting%20Ubuntu%20Swap%20File.html">
           Setting Ubuntu Swap File
          </a>
         </li>
         <li>
          <a href="Setting%20Up%20CUPS%20Network%20Printer%20on%20Ubuntu.html">
           Setting Up CUPS Network Printer on Ubuntu
          </a>
         </li>
         <li>
          <a href="Using%20Git%20for%20File%20Metadata.html">
           Using Git for File Metadata (in regards to create and update)
          </a>
         </li>
         <li>
          <a href="Utilities.html">
           Utilities
          </a>
         </li>
        </ul>
       </li>
       <li class="directory">
        <div class="label">
         <a href="../4.%20Uncategorized/8%20Daily%20Routines%20to%20Dominate%20the%20Market.html">
          4. Uncategorized
         </a>
        </div>
        <ul>
         <li>
          <a href="../4.%20Uncategorized/8%20Daily%20Routines%20to%20Dominate%20the%20Market.html">
           No Title
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Buffett%20on%20Finding%20Intrinsic%20Value.html">
           Buffett on Finding Intrinsic Value
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Letter%20from%20Lego.html">
           Letter from Lego
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Links%20of%20Interest.html">
           Links of Interest
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Lyrics%20to%20an%20Unknown%20Song.html">
           Lyrics to an Unknown Song
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Quotes.html">
           Quotes
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Stop%20Spending%20Huge%20Amounts%20of%20Money%20on%20Online%20Courses%20Forever.html">
           Stop Spending Huge Amounts of Money on Online Courses Forever
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/TODOs.html">
           TODOs
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Think%20and%20TRADE%20Rich.html">
           Think and TRADE Rich
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Tigo%20Service%20Numbers.html">
           Tigo Service Numbers and Their Meanings
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Warren%20Buffet%27s%20Ten%20Rules.html">
           Warren Buffett's Ten Rules
          </a>
         </li>
         <li>
          <a href="../4.%20Uncategorized/Why%20I%27m%20Switching%20from%20Evernote%20to%20Markdown.html">
           Why I'm Switching from Evernote to Markdown
          </a>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
   </nav>
   <footer>
    <nav>
     <a class="previous" href="Implementing%20Full-Text%20Search.html">
      « Previous
     </a>
     <a class="next" href="Python%20via%20WASM.html">
      Next »
     </a>
    </nav>
   </footer>
  </aside>
  <article id="main-content">
   <nav>
    <a href="../index.html">
     Home
    </a>
    &gt;
    <a href="../3.%20Nerdy%20Stuff/A%20Tester%20Walks%20Into%20A%20Bar.html">
     3. Nerdy Stuff
    </a>
    &gt; Mixture of Experts: How to Properly Scale LLMs
   </nav>
   <p>
    Estimated reading time: 2 minute(s).
   </p>
   <div>
    <h1 id="mixture-of-experts-how-to-properly-scale-llms">
     Mixture of Experts: How to Properly Scale LLMs
    </h1>
    <p>
     Reference:
     <a href="https://www.linkedin.com/posts/damienbenveniste_these-days-you-blink-and-there-are-20-new-activity-7178417751282081793-EyiP?utm_source=share&amp;utm_medium=member_desktop" rel="noopener noreferrer" target="_blank">
      https://www.linkedin.com/posts/damienbenveniste_these-days-you-blink-and-there-are-20-new-activity-7178417751282081793-EyiP?utm_source=share&amp;utm_medium=member_desktop
     </a>
    </p>
    <p class="has-drop-cap">
     These days, you blink, and there are 20 new Machine Learning techniques or tools you need to learn about! The Mixture of Experts architecture is by no means a new technique, but it has now become the default strategy for scaling LLMs. I remember reading about it a couple of years ago and dismissing it as "yet another LLM paper that probably doesn't matter". Well, now it matters! Most larger LLMs are likely to use that strategy moving forward!
    </p>
    <p>
     The typical transformer block is a succession of an attention layer, layer normalization, feed-forward layer, and another layer normalization. The strategy to scale transformers has been to just add more transformer blocks one after the other. The idea with MoE is to scale "horizontally" by adding more parallel feed-forward layers in each of the blocks. Those are the "experts".
    </p>
    <p>
     Prior to the experts layer, we add a router so that each token only goes through a few experts. For example, we can have 64 experts, but with the token's hidden states only going through 2 of those. This ensures diverse learning while minimizing the computational load and, therefore, latency at inference time.
    </p>
    <p>
     The router is just a linear layer that takes a hidden state and produces a vector with as many entries as there are experts. By using a softmax transformation, we get a probability for each of the experts. We can now use those probabilities to select the top-k experts and build a weighted average of the output of the selected experts. For example, if we take the top 2 experts:
    </p>
    <pre><code class="language-python">new state = P(FFN_1) * FFN_1 (hidden state) + P(FFN_2) * FFN_2 (hidden state)
</code></pre>
    <p>
     Even with only the top-2 experts, the new output hidden state can represent a much richer set of information learned by the different combinations of experts. This also provides a very natural way to distribute the model computations across multiple GPU machines. Each machine can hold multiple experts, and the computations of the different experts can happen in parallel on the different machines.
    </p>
    <p>
     However, training a MoE model is not trivial as it induces a lot of training instabilities. One difficulty is ensuring each expert sees enough data to learn the relevant statistical patterns. The typical strategy is adding a term to the loss function to provide a balanced data load across experts.
    </p>
    <p>
     Google has been leading the charge on that front, so these are worth a read:
    </p>
    <ul>
     <li>
      <a href="https://arxiv.org/pdf/2202.08906.pdf" rel="noopener noreferrer" target="_blank">
       ST-MOE: Designing Stable and Transferable
Sparse Expert Models
      </a>
     </li>
     <li>
      <a href="https://arxiv.org/pdf/2101.03961.pdf" rel="noopener noreferrer" target="_blank">
       Switch Transformers: Scaling to Trillion Parameter Models
with Simple and Efficient Sparsity
      </a>
     </li>
    </ul>
    <p>
     <img alt="Mixture of Experts: How to Properly Scale LLMs" src="../images/moe-scaling-llms.jpeg"/>
    </p>
   </div>
   <footer>
    <div class="build_datetime">
     Build datetime: 2024-10-14 23:43:35 +0000
    </div>
    <nav>
     <a class="previous" href="Implementing%20Full-Text%20Search.html">
      « Previous
     </a>
     <a class="next" href="Python%20via%20WASM.html">
      Next »
     </a>
    </nav>
   </footer>
  </article>
 </body>
</html>
